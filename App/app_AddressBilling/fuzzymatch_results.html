{% extends "base.html" %}
{% block title %}Fuzzymatch Results - {{ batch_id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12 text-center mb-3">
      <h1 class="display-6">Fuzzymatch Results for Batch: {{ batch_id }}</h1>
    </div>
  </div>

  <!-- Top Action Buttons Row -->
  <div class="row mb-3">
    <div class="col-12 d-flex flex-wrap justify-content-center gap-3">
      <a 
        href="{{ url_for('show_fuzzymatch_summary', batch_id=batch_id) }}"
        class="btn btn-info"
      >
        Summary View
      </a>
      <a 
        href="{{ url_for('download_fuzzymatch_excel', batch_id=batch_id) }}"
        class="btn btn-success"
        target="_blank"
      >
        Download Excel
      </a>
      <a 
        href="{{ url_for('download_fuzzymatch_csv', batch_id=batch_id) }}"
        class="btn btn-success"
        target="_blank"
      >
        Download CSV
      </a>
      <a
        href="{{ url_for('upload') }}"
        class="btn btn-primary"
      >
        Upload Another File
      </a>
    </div>
  </div>

  {% if notice %}
  <div class="row mb-2">
    <div class="col text-center">
      <small class="text-danger">
        {{ notice }}
      </small>
    </div>
  </div>
  {% endif %}

  {% if total_rows %}
  <div class="row mb-2">
    <div class="col text-center">
      <small class="text-muted">
        {{ total_rows }} total rows in this batch
      </small>
    </div>
  </div>
  {% endif %}

  <div class="table-responsive">
    <table 
      id="fuzzymatchTable"
      class="table table-striped table-hover table-bordered w-100"
    >
      <thead class="table-dark">
        <tr>
          {% for col in columns_list %}
          <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in data_rows %}
        <tr>
          {% for val in row %}
          <td>{{ val }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- DataTables + jQuery are typically in base.html, but repeated here for clarity -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css"
/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 1) Clone the first row to create a filter row
  const thead = document.querySelector('#fuzzymatchTable thead');
  const headerRow = thead.rows[0];
  const filterRow = headerRow.cloneNode(true);

  // 2) For each cell, add a small <input> for searching
  Array.from(filterRow.cells).forEach(function(cell) {
    cell.innerHTML = '<input type="text" class="form-control form-control-sm" placeholder="Filter..." />';
  });
  thead.appendChild(filterRow);

  // 3) Initialize DataTable with horizontal + vertical scrolling
  const table = $('#fuzzymatchTable').DataTable({
    pageLength: 25,
    scrollX: true,
    scrollY: '50vh',
    autoWidth: false
  });

  // 4) Wire up the filter row for column-based searching
  table.columns().every(function(colIdx) {
    const input = filterRow.cells[colIdx].querySelector('input');
    if (input) {
      input.addEventListener('keyup', function() {
        table
          .column(colIdx)
          .search(this.value)
          .draw();
      });
    }
  });
});
</script>
{% endblock %}
