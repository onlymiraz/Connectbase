<!-- /App/app_AddressBilling/batch_history.html -->
{% extends "base.html" %}
{% block title %}All Batches (Pending & Done){% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>All Batches (Pending &amp; Done)</h1>
  <hr />

  <p class="text-muted">
    This list shows each <strong>distinct</strong> batch_id from UI_LZ + UI_LZ_Archive,
    plus the total fuzzymatch row count from main+archive.
    Use the filter boxes below to search.
  </p>

  <div class="table-responsive">
    <table
      id="batchHistoryTable"
      class="display table table-striped table-hover w-100"
    >
      <thead>
        <tr>
          <th>Batch ID</th>
          <th>Email</th>
          <th>Ingestion Time</th>
          <th>Status</th>
          <th>Fuzzymatch Count</th> <!-- new column -->
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for row in df %}
        <tr>
          <td>{{ row.batch_id }}</td>
          <td>{{ row.user_email }}</td>
          <td>{{ row.ingestion_timestamp }}</td>
          <td>{{ row.process_status }}</td>
          <td>{{ row.fz_count }}</td> <!-- show fuzzymatch count -->
          <td>
            <a 
              href="{{ url_for('show_fuzzymatch_results', batch_id=row.batch_id) }}"
              class="btn btn-sm btn-primary"
              target="_blank"
            >
              Details
            </a>
            <a 
              href="{{ url_for('download_fuzzymatch_excel', batch_id=row.batch_id) }}"
              class="btn btn-sm btn-success"
              target="_blank"
            >
              Excel
            </a>
            <a 
              href="{{ url_for('download_fuzzymatch_csv', batch_id=row.batch_id) }}"
              class="btn btn-sm btn-success"
              target="_blank"
            >
              CSV
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css"
/>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const thead = document.querySelector('#batchHistoryTable thead');
  const headerRow = thead.rows[0];
  const filterRow = headerRow.cloneNode(true);

  // We want to place <input> on the first 5 columns (0..4).
  // The 6th column (Actions) => skip.
  Array.from(filterRow.cells).forEach(function(cell, idx) {
    if (idx < 5) {
      cell.innerHTML = '<input type="text" class="form-control form-control-sm" placeholder="Filter...">';
    } else {
      cell.innerHTML = '';
    }
  });

  thead.appendChild(filterRow);

  const table = $('#batchHistoryTable').DataTable({
    pageLength: 10,       // smaller default => less "wide"
    // scrollX: true,     // comment or remove to avoid wide overflow
    orderCellsTop: true,
    autoWidth: false
  });

  // wire up the filter row
  table.columns().every(function(idx) {
    if (idx >= 5) return;
    const input = filterRow.cells[idx].querySelector('input');
    if (!input) return;
    input.addEventListener('keyup', function() {
      table
        .column(idx)
        .search(this.value)
        .draw();
    });
  });
});
</script>
{% endblock %}
