<!-- /App/app_AddressBilling/view_batch_data.html -->
{% extends "base.html" %}
{% block title %}All Address Billing Batches{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>All Address Billing Batches</h1>
  <hr />

  <!-- Server-side search -->
  <form method="POST" class="mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label for="search_query" class="col-form-label">Filter (server-side):</label>
      </div>
      <div class="col-auto">
        <input
          type="text"
          class="form-control"
          id="search_query"
          name="search_query"
          placeholder="Type text to filter by batch/email/status"
          value="{{ search_query|default('') }}"
        >
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">
          Search
        </button>
      </div>
    </div>
  </form>

  <!-- DataTables with second row => combobox filters -->
  <table 
    id="batchTable" 
    class="display table table-striped table-hover"
    style="width:100%"
  >
    <thead>
      <tr>
        <th>Batch ID</th>
        <th>User Email</th>
        <th>Ingestion Time</th>
        <th>Status</th>
        <th>Row Count</th>
        <th>Actions</th>
      </tr>
      <tr class="filters-row">
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th><!-- No filter for actions col --></th>
      </tr>
    </thead>
    <tbody>
      {% for row in df.itertuples() %}
      <tr>
        <td>{{ row.batch_id }}</td>
        <td>{{ row.user_email }}</td>
        <td>{{ row.ingest_time }}</td>
        <td>{{ row.status }}</td>
        <td>{{ row.row_count }}</td>
        <td>
          <!-- open in new tab so no blocking/spinning on large results -->
          <a 
            class="btn btn-sm btn-info"
            href="{{ url_for('fuzzymatch_powerbi_view') }}?batch_id={{ row.batch_id }}"
            target="_blank"
          >
            Power BIâ€“like
          </a>
          <a 
            class="btn btn-sm btn-secondary"
            href="{{ url_for('show_fuzzymatch_results', batch_id=row.batch_id) }}"
            target="_blank"
          >
            Paginated
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- DataTables + Select2 -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css"
/>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
  const table = $('#batchTable').DataTable({
    pageLength: 25,
    scrollX: true
  });

  table.columns().every(function(colIdx) {
    // skip Actions col
    if (colIdx === 5) return;

    const headerCell = document.querySelector(
      '#batchTable thead tr.filters-row th:nth-child(' + (colIdx+1) + ')'
    );
    if (!headerCell) return;

    const sel = document.createElement('select');
    sel.classList.add('form-select','form-select-sm');

    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All';
    sel.appendChild(optAll);

    // Unique data
    table.column(colIdx).data().unique().sort().each(function(value) {
      if (!value) return;
      const o = document.createElement('option');
      o.value = value;
      o.textContent = value;
      sel.appendChild(o);
    });

    headerCell.appendChild(sel);

    sel.addEventListener('change', function() {
      const v = sel.value;
      if (!v) {
        table.column(colIdx).search('').draw();
      } else {
        table.column(colIdx).search('^'+v+'$', true, false).draw();
      }
    });
  });

  $('#batchTable thead tr.filters-row select').select2({
    width: '100%',
    placeholder: 'All',
    allowClear: true
  });
});
</script>
{% endblock %}
