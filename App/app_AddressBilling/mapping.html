<!-- /App/app_AddressBilling/mapping.html -->
{% extends "base.html" %}
{% block title %}Map Columns{% endblock %}
{% block content %}

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <h1 class="text-center mt-4 mb-4">Map Excel Columns to Database Columns</h1>

      <form action="{{ url_for('process_mapping') }}" method="post" onsubmit="showProcessingOverlay()">
        <!-- 
          If user selected an Excel sheet, we might have it in session,
          but also pass it along as a hidden input. If CSV => no sheet needed.
        -->
        {% if sheet_name %}
        <input type="hidden" name="sheet_name" value="{{ sheet_name }}">
        {% endif %}

        <!-- 
          We show the user all the DB columns (sql_columns) except the excluded ones,
          and let them pick from the "file_columns" in a <select>.
        -->
        {% set custom_order = ["Address1", "Address2", "City", "State", "Zip", "Country"] %}
        {% set excluded_cols = ["user_email", "process_status"] %}

        <div class="mapping-container">

          {# 1) Show columns in custom_order first #}
          {% for desired_col in custom_order %}
            {% if desired_col in sql_columns and desired_col not in excluded_cols %}
              {% set details = sql_columns[desired_col] %}
              <div class="mapping-row">
                <div class="source-col">
                  <select 
                    name="{{ desired_col }}" 
                    class="select-small"
                    {% if details.nullable == 'NO' %}required{% endif %}
                  >
                    <option value="">-- Select --</option>
                    {% for file_col in file_columns %}
                    <option value="{{ file_col }}">{{ file_col }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="arrow">→</div>
                <div class="target-col">
                  <label>
                    {{ desired_col }}
                    {% if details.nullable == 'NO' %}
                      <span class="required">*</span>
                    {% else %}
                      <span class="optional">(Optional)</span>
                    {% endif %}
                    <span class="data-type">
                      ({{ details.data_type }}{% if details.max_length %}({{ details.max_length }}){% endif %})
                    </span>
                  </label>
                </div>
              </div>
            {% endif %}
          {% endfor %}

          {# 2) Then leftover columns not in custom_order + not excluded #}
          {% for sql_col, details in sql_columns.items() %}
            {% if sql_col not in custom_order and sql_col not in excluded_cols %}
              <div class="mapping-row">
                <div class="source-col">
                  <select 
                    name="{{ sql_col }}"
                    class="select-small"
                    {% if details.nullable == 'NO' %}required{% endif %}
                  >
                    <option value="">-- Select --</option>
                    {% for file_col in file_columns %}
                    <option value="{{ file_col }}">{{ file_col }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="arrow">→</div>
                <div class="target-col">
                  <label>
                    {{ sql_col }}
                    {% if details.nullable == 'NO' %}
                      <span class="required">*</span>
                    {% else %}
                      <span class="optional">(Optional)</span>
                    {% endif %}
                    <span class="data-type">
                      ({{ details.data_type }}{% if details.max_length %}({{ details.max_length }}){% endif %})
                    </span>
                  </label>
                </div>
              </div>
            {% endif %}
          {% endfor %}

        </div>

        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary">Process Data</button>
        </div>
      </form>

      <!-- Overlay spinner -->
      <div id="processing-overlay"
           style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                  background:rgba(0,0,0,0.5); z-index:9999; text-align:center; color:white;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
          <div class="spinner-border text-light" role="status" style="width:3rem; height:3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h3 class="mt-3">Processing Data...</h3>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
function showProcessingOverlay() {
  document.getElementById('processing-overlay').style.display = 'block';
}
</script>
{% endblock %}
