USE CapitalManagementStaging


EXEC('TRUNCATE TABLE CapitalManagementProduction."+ @[User::TableName_str] +"') AT [CAPINFWWAPV01]



DECLARE @PK_Condition AS int
DECLARE @ID_Condition AS int
DECLARE @PK_Table_Columns AS NVARCHAR(MAX)
DECLARE @Main_Insert_Query AS NVARCHAR(MAX)
DECLARE @Main_Insert_Query_PK1 AS NVARCHAR(MAX)
DECLARE @Main_Insert_Query_PK2 AS NVARCHAR(MAX)



SET @PK_Condition = (
	SELECT COUNT(*) 
	FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS 
	WHERE [CONSTRAINT_TYPE] = 'PRIMARY KEY' AND TABLE_NAME = SUBSTRING('"+ @[User::TableName_str] +"', CHARINDEX('.','"+ @[User::TableName_str] +"')+1, 20000)
)



SET @ID_Condition = (
		SELECT COUNT(*)
		FROM
			sys.schemas AS SCH
			INNER JOIN sys.tables AS TAB ON SCH.schema_id = TAB.schema_id
			INNER JOIN sys.columns AS COL ON TAB.object_id = COL.object_id
			INNER JOIN sys.identity_columns AS IDCOL on COL.object_id = IDCOL.object_id AND COL.column_id = IDCOL.column_id
		WHERE TAB.name = SUBSTRING('"+ @[User::TableName_str] +"', CHARINDEX('.','"+ @[User::TableName_str] +"')+1, 20000)
	)




SET @PK_Table_Columns = (REPLACE( (SELECT SUBSTRING(
			(
				SELECT ', ' + QUOTENAME(COLUMN_NAME)
				FROM INFORMATION_SCHEMA.COLUMNS
				WHERE TABLE_NAME = SUBSTRING('"+ @[User::TableName_str] +"', CHARINDEX('.','"+ @[User::TableName_str] +"')+1, 20000) AND TABLE_SCHEMA = SUBSTRING('"+ @[User::TableName_str] +"', 0, CHARINDEX('.','"+ @[User::TableName_str] +"'))
				ORDER BY ORDINAL_POSITION
				FOR XML path('')
			),
        3, 200000)), '''', '')) 



SET @Main_Insert_Query = N'

	INSERT INTO [CAPINFWWAPV01].CapitalManagementProduction."+ @[User::TableName_str] +" ('+ @PK_Table_Columns +') 
			SELECT ' + @PK_Table_Columns + ' FROM CAPINFWWWPV01.CapitalManagementStaging."+ @[User::TableName_str] +"
'


SET @Main_Insert_Query_PK1 = N'

	INSERT INTO [CAPINFWWAPV01].CapitalManagementProduction.dbo.TempDestinationTable ('+ @PK_Table_Columns +') 
			SELECT ' + @PK_Table_Columns + ' FROM CAPINFWWWPV01.CapitalManagementStaging."+ @[User::TableName_str] +"

'

SET @Main_Insert_Query_PK2 = N'

	IF(' + CAST(@ID_Condition AS nvarchar) + ' > 0)
		BEGIN
			SET IDENTITY_INSERT CapitalManagementProduction."+ @[User::TableName_str] +" ON

			INSERT INTO CapitalManagementProduction."+ @[User::TableName_str] +" ('+ @PK_Table_Columns +') 
					SELECT ' + @PK_Table_Columns + ' FROM CapitalManagementProduction.dbo.TempDestinationTable

			SET IDENTITY_INSERT CapitalManagementProduction."+ @[User::TableName_str] +" OFF
		END
	
	ELSE
		BEGIN
			INSERT INTO CapitalManagementProduction."+ @[User::TableName_str] +" ('+ @PK_Table_Columns +') 
					SELECT ' + @PK_Table_Columns + ' FROM CapitalManagementProduction.dbo.TempDestinationTable
		END
	DROP TABLE CapitalManagementProduction.dbo.TempDestinationTable
'




IF(@ID_Condition > 0 OR @PK_Condition > 0)
	BEGIN
		EXECUTE [CAPINFWWAPV01].CapitalManagementProduction.dbo.createtemptable '"+ @[User::TableName_str] +"'
        
		EXEC(@Main_Insert_Query_PK1)
		EXEC(@Main_Insert_Query_PK2) AT [CAPINFWWAPV01]
	END


ELSE
	BEGIN
		EXEC(@Main_Insert_Query)
	END



