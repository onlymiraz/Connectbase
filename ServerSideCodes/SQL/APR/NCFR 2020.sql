--FOR NCFR DETAIL - NUMERATOR   
/*
SELECT CUSTOMER, AREA, 
PRODUCT, COUNT(*) NUM, NULL DEN
FROM (;
--
*/

SELECT DOCUMENT_NUMBER, PON, ACT_IND, COMP_DT, DD_TASK_COMP, NPANXX, CLLI, ICSC, 
 CASE WHEN ICSC IN ('GT10','GT11') and state = 'CA' THEN 'CA' ELSE 'LEGACY' END AREA,
 ACNA, CUSTOMER,
 --CASE WHEN ACNA IN ('HOC','UXW','CPO','NVA','LTP','DLT','BTI','NGE') THEN 'EARTHLINK'
   --   ELSE CUSTOMER END CUSTOMER,
 REGION, TERRITORY, LAM, STATE,  
 CASE WHEN PRODUCT LIKE 'ETHERNET%' THEN 'Ethernet' ELSE PRODUCT END PRODUCT,
 CKT, 
 MIN(TICKET_ID) TICKET_ID, 
 MIN(ASSIGNMENTPROFILE) KEEP (DENSE_RANK FIRST ORDER BY TICKET_ID) ASSIGNMENTPROFILE,
 MIN(REPAIR_CODE) KEEP (DENSE_RANK FIRST ORDER BY TICKET_ID) REPAIR_CODE, 
 MIN(DISP) KEEP (DENSE_RANK FIRST ORDER BY TICKET_ID) DISP,
 MIN(TRBL_CREATE_DATE) KEEP (DENSE_RANK FIRST ORDER BY TICKET_ID) TRBL_CREATE_DATE,
 MIN(TRBL_CLEARED_DT) KEEP (DENSE_RANK FIRST ORDER BY TICKET_ID) TRBL_CLEARED_DT,
 MIN(TRBL_CLOSED_DT) KEEP (DENSE_RANK FIRST ORDER BY TICKET_ID) TRBL_CLOSED_DT,
 CASE WHEN MON = 12 THEN 1 ELSE MON+1 END MON                                               --USE PLUS 1 TO ACCOMODATE THE SPREADSHEET WITH THIS ONE MONTH IN ARREARS              
 FROM (
    SELECT DISTINCT DOCUMENT_NUMBER, PON, ACT_IND, COMP_DT, DD_TASK_COMP, NPANXX, CLLI, ICSC, ACNA, CUSTOMER,
    REGION, TERRITORY, LAM, STATE, PRODUCT, CKT, TICKET_ID, ASSIGNMENTPROFILE, REPAIR_CODE, TFR.DISP, TO_CHAR(DD_TASK_COMP,'MM') MON,  
    CREATE_DATE TRBL_CREATE_DATE, 
	CASE WHEN CLEARED_DT IS NOT NULL THEN CLEARED_DT
            ELSE CLOSED_DT END TRBL_CLEARED_DT, 
	CASE WHEN CLOSED_DT IS NOT NULL THEN CLOSED_DT
            ELSE CLEARED_DT END TRBL_CLOSED_DT
    FROM (
        SELECT DISTINCT DOCUMENT_NUMBER, PON, ACT_IND, COMP_DT, DD_TASK_COMP, NPANXX, CLLI, ICSC, A.ACNA, CUSTOMER,
        REGION, TERRITORY, LAM, STATE, PRODUCT, CKT,
        TT.FLD_REQUESTID TICKET_ID,
        MAX(TT.FLD_COMPLETE_REPAIRCODE) KEEP (DENSE_RANK LAST ORDER BY TT.FLD_MODIFIEDDATE) REPAIR_CODE,
        MAX(TRIM(TT.FLD_ASSIGNMENTPROFILE)) KEEP (DENSE_RANK FIRST ORDER BY TT.FLD_MODIFIEDDATE) ASSIGNMENTPROFILE, 
        MAX(TT.FLD_REQUESTSTATUS) KEEP (DENSE_RANK LAST ORDER BY TT.FLD_MODIFIEDDATE) REQSTAT,
        MAX(TT.FLD_REQUESTTYPE) KEEP (DENSE_RANK LAST ORDER BY TT.FLD_MODIFIEDDATE) REQUEST_TYPE,
        MAX(TT.FLD_STARTDATE) KEEP (DENSE_RANK LAST ORDER BY TT.FLD_MODIFIEDDATE) CREATE_DATE,
	    MAX(TT.FLD_EVENT_END_TIME) KEEP (DENSE_RANK LAST ORDER BY TT.FLD_MODIFIEDDATE) CLEARED_DT, 
        MAX(TT.DTE_CLOSEDDATETIME) KEEP (DENSE_RANK LAST ORDER BY TT.FLD_MODIFIEDDATE) CLOSED_DT,
        MAX(TT.FLD_MODIFIEDDATE) MOD_DATE
        FROM (  
            SELECT DOCUMENT_NUMBER, PON, ACT_IND, DREC, DD, DDD, COMP_DT, DD_TASK_COMP, 
            NCFR.NPANXX, CLLI, ICSC, NCFR.ACNA, CUSTOMER, PRODUCT, CKT, 
            CASE WHEN LAMN.REGION IS NOT NULL THEN LAMN.REGION ELSE NULL END REGION,
            CASE WHEN LAMN.TERRITORY IS NOT NULL THEN LAMN.TERRITORY ELSE NULL END TERRITORY,
            CASE WHEN LAMN.LOCAL_MKT IS NOT NULL THEN LAMN.LOCAL_MKT ELSE NULL END LAM,
            CASE WHEN LAMN.STATE IS NOT NULL THEN LAMN.STATE
            ELSE NCFR.STATE END STATE
            FROM NCFRWEEKLY NCFR, 
                 LAM_NPANXX LAMN
            WHERE NCFR.NPANXX = LAMN.NPANXX (+)
            AND TO_CHAR(DD_TASK_COMP,'YYYYMM') = '202311'                    --CHANGE THIS EACH MONTH  - SHOULD SHOW PREVIOUS MONTH   
        )A, CASDW.TROUBLE_TICKET_R TT
     WHERE A.CKT = TT.EXCHANGE_CARRIER_CIRCUIT_ID
     AND TT.FLD_TROUBLEREPORTSTATE = 'closed'
     AND TT.FLD_ASSIGNMENTPROFILE IN ('CNOC','Commercial-CTF','FTW TSC','CTF TSC')
     AND TO_CHAR(FLD_STARTDATE,'yyyymm') IN ('202311','202312')  --MUST CHANGE THESE DATES EACH MONTH TO SHOW CURRENT AND PREVIOUS MONTH  
     AND TO_CHAR(TT.FLD_STARTDATE,'YYYYMMDD') >= TO_CHAR(A.COMP_DT,'YYYYMMDD') 
     GROUP BY DOCUMENT_NUMBER, PON, ACT_IND, COMP_DT, DD_TASK_COMP, NPANXX, CLLI, ICSC, A.ACNA, CUSTOMER, 
              REGION, TERRITORY, LAM, STATE, PRODUCT, CKT, TT.FLD_REQUESTID
   )B, TRBL_FOUND_REMEDY TFR           
   WHERE B.REPAIR_CODE = TFR.TRBL_FOUND_DESC (+)  
   AND (REQUEST_TYPE IN ('Agent','Alarm','Customer','Maintenance')
   OR ASSIGNMENTPROFILE IN ('FTW TSC','CTF TSC'))
   AND TFR.DISP IN ('CO','FAC')           
)
WHERE TRBL_CREATE_DATE - COMP_DT <31
AND TO_CHAR(TRBL_CREATE_DATE,'YYYYMMDD') >= TO_CHAR(COMP_DT,'YYYYMMDD')
AND CUSTOMER IS NOT NULL
AND STATE NOT IN ('WA','OR','ID','MT')
GROUP BY DOCUMENT_NUMBER, PON, ACT_IND, COMP_DT, DD_TASK_COMP, NPANXX, CLLI, ICSC, ACNA, CUSTOMER, 
         REGION, TERRITORY, LAM, STATE, PRODUCT, CKT, MON
ORDER BY 11,12,13,16;


    
 
 
--FOR NCFR DENOMINATOR  
          
SELECT CUSTOMER,  
PRODUCT, NULL NUM, COUNT(*) DEN   
FROM (            
            SELECT DOCUMENT_NUMBER, NCFR.STATE, DD_TASK_COMP, NCFR.NPANXX, CLLI, ACNA, CUSTOMER, 
            --CASE WHEN ACNA IN ('HOC','UXW','CPO','NVA','LTP','DLT','BTI','NGE') THEN 'EARTHLINK'
             --ELSE CUSTOMER END CUSTOMER,
            CASE WHEN PRODUCT LIKE 'ETHERNET%' THEN 'Ethernet' ELSE PRODUCT END PRODUCT,
            CKT
            FROM NCFRWEEKLY NCFR, 
                 LAM_NPANXX LAMN
            WHERE NCFR.NPANXX = LAMN.NPANXX (+)
            AND NCFR.STATE NOT IN ('WA','OR','ID','MT') 
            AND TO_CHAR(DD_TASK_COMP,'YYYYMM') = '202311'                    --CHANGE THIS EACH MONTH  - SHOULD SHOW PREVIOUS MONTH     
  ) 
  GROUP BY CUSTOMER, PRODUCT
  ORDER BY 1,2,3;          
  
;


--FOR NCFR DENOMINATOR  - VZB NEW ONLY   
          
SELECT CUSTOMER,  
PRODUCT, NULL NUM, COUNT(*) DEN   
FROM (            
            SELECT DOCUMENT_NUMBER, DD_TASK_COMP, NCFR.NPANXX, CLLI, ACNA, CUSTOMER, 
            CASE WHEN PRODUCT LIKE 'ETHERNET%' THEN 'Ethernet' ELSE PRODUCT END PRODUCT,
            CKT
            FROM NCFRWEEKLY NCFR, 
                 LAM_NPANXX LAMN
            WHERE NCFR.NPANXX = LAMN.NPANXX (+)
            AND ACT_IND = 'N'
            AND CUSTOMER IN ('VERIZON')
            AND NCFR.STATE NOT IN ('WA','OR','ID','MT') 
            AND TO_CHAR(DD_TASK_COMP,'YYYYMM') = '202311'                    --CHANGE THIS EACH MONTH  - SHOULD SHOW PREVIOUS MONTH  
  )     
  GROUP BY CUSTOMER, PRODUCT
  ORDER BY 1,2,3;          
  

