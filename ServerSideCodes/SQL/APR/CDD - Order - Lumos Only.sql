SELECT DISTINCT ORDER_NUMBER, PON, CKT CIRCUIT, CUSTOMER, ASR_INIT, CLEANASR, DD DUE_DATE, IN_EFFECT_DT COMP_DT, DD_COMP DD_TASK_COMP, SERVICE, 
       CASE WHEN EVC_IND = 'B' THEN 'COMBO'
            WHEN EVC_IND = 'A' THEN 'EVC'
            WHEN UNI_OR_NNI = 'NNI' THEN 'NNI'
            WHEN UNI_OR_NNI = 'UNI' THEN 'UNI'
            WHEN SUBSTR(CKT,4,2) IN ('KG','SX','KS') THEN 'NNI'
            WHEN SERVICE = 'ETHERNET' THEN 'UNI'
            ELSE NULL END PROD_SUB,
       EVC_IND, ACT_IND ACT, 
       ACNA, STATE,  
       CASE WHEN ICSC IN ('GT10','GT11') THEN 'CTF' ELSE 'Legacy' END AREA,
       ICSC, PROJ PROJECT, 
       CASE WHEN IN_EFFECT_DT <= DD THEN NULL 
            WHEN WMRCA IS NOT NULL THEN WMRCA ELSE WM END WHY_MISS,
       CASE WHEN IN_EFFECT_DT <= DD THEN NULL 
            WHEN WMRCA IS NOT NULL THEN WMRCA_DESC ELSE WM_DESC END WHY_MISS_DESC,      
       DDD,
       CASE WHEN (IN_EFFECT_DT <= DD OR DD IS NULL) THEN 'Met'
            WHEN (IN_EFFECT_DT > DD AND WMRCA IN ('CU01','CU02','CU03','CU04','CU05','DS02','CA22','EX01','CU51','CU52','CU53','CU54','DS52','PM53')) THEN 'Met'
            WHEN (IN_EFFECT_DT > DD AND WMRCA IS NULL AND WM IN ('CU01','CU02','CU03','CU04','CU05','DS02','CA22','EX01','CU51','CU52','CU53','CU54','DS52','PM53')) THEN 'Met'
            ELSE 'Miss' END DD_STATUS, 
       CASE WHEN (IN_EFFECT_DT <= DDD OR DDD IS NULL) THEN 'Met'
            WHEN (IN_EFFECT_DT > DDD AND WMRCA IN ('CU01','CU02','CU03','CU04','CU05','DS02','CA22','CU51','CU52','CU53','CU54','DS52','PM53')) THEN 'Met'
            WHEN (IN_EFFECT_DT > DDD AND WMRCA IS NULL AND WM IN ('CU01','CU02','CU03','CU04','CU05','DS02','CA22','CU51','CU52','CU53','CU54','DS52','PM53')) THEN 'Met'
            ELSE 'Miss' END DDD_STATUS,        
       CASE WHEN BUILD_IOF LIKE '%IOFMINOR%' THEN 'MINOR BUILD'
            WHEN BUILD_IOF LIKE '%IOFMAJOR%' THEN 'MAJOR BUILD'
            WHEN BUILD_IOF LIKE '%IOFCOMPLEX%' THEN 'MAJOR BUILD'
            WHEN BUILD_OSP LIKE '%OSPMINOR%' THEN 'MINOR BUILD'
            WHEN BUILD_OSP LIKE '%OSPMAJOR%' THEN 'MAJOR BUILD'
            WHEN BUILD_OSP LIKE '%OSPCOMPLEX%' THEN 'MAJOR BUILD'
            ELSE 'NO BUILD' END BUILD,
       BUILD_IOF, BUILD_OSP
FROM (
SELECT PON, DOCUMENT_NUMBER ORDER_NUMBER, REQUEST_TYPE, ACT_IND, SUPP_TYPE, ASR_INIT, CLEANASR, DD, DDD, ACCEPT_DT, DD_COMP, 
         CASE WHEN DD_COMP IS NULL AND ACCEPT_DT > CLEANASR THEN ACCEPT_DT
            WHEN ACCEPT_DT IS NULL THEN DD_COMP
            WHEN ACCEPT_DT <= DD_COMP AND ACCEPT_DT > CLEANASR THEN ACCEPT_DT 
            ELSE DD_COMP END IN_EFFECT_DT, 
         ICSC, PROJ, ACNA, EVC_IND, 
         CASE WHEN ACNA IN ('FET','FWN') THEN 'LUMOS'
           ELSE NULL END CUSTOMER,                    
         CASE WHEN NPASTATE IS NOT NULL THEN NPASTATE
              WHEN STATE1 IS NOT NULL THEN STATE1
              WHEN SEC_STATE IS NOT NULL THEN SEC_STATE
              WHEN PRI_STATE IS NOT NULL THEN PRI_STATE
              WHEN ICSC = 'FV01' THEN 'WV'
              WHEN ICSC = 'RT01' THEN 'NY'
              WHEN ICSC = 'SN01' THEN 'CT'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '83' THEN 'ID'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '85' THEN 'OR'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '86' THEN 'WA'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '30' THEN 'IL'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '61' THEN 'NC'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '62' THEN 'SC'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '31' THEN 'IN'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '33' THEN 'MI'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '36' THEN 'OH'
              WHEN SUBSTR(ICSC,1,2) = 'FV' AND SUBSTR(CKT,1,2) = '39' THEN 'WI'
              WHEN SUBSTR(PROJ,1,7) = 'ATTMOB-' THEN SUBSTR(PROJ,12,2)
              ELSE NULL END STATE, 
         CASE WHEN (SUBSTR(RATE_CODE,1,2) = 'OC' OR SUBSTR(NC,1,1) = 'O') THEN 'OCN'
              WHEN (NC = 'HC' OR SUBSTR(CKT,4,2) = 'HC') THEN 'DS1'
              WHEN (NC = 'HF' OR SUBSTR(CKT,4,2) = 'HF') THEN 'DS3'
              WHEN SUBSTR(CKT,7,2) = 'T1' THEN 'DS1'
              WHEN SUBSTR(CKT,7,2) = 'T3' THEN 'DS3'
              WHEN SUBSTR(NC,1,1) IN ('L','X') THEN 'DS0'
              WHEN SUBSTR(CKT,4,1) IN ('L','X') THEN 'DS0'
              WHEN SUBSTR(CKT,4,2) IN ('OS','FX','UC','UG','CL') THEN 'DS0'
              WHEN SUBSTR(CKT,4,2) IN ('YG','QG','DH','YB') THEN 'DS0'
              WHEN SUBSTR(NC,1,2) = 'SN' THEN 'ETHERNET'
              WHEN EVC_IND = 'B' THEN 'ETHERNET'
              WHEN EVC_IND = 'A' THEN 'ETHERNET'
              WHEN (SUBSTR(NC,1,1) = 'K' OR SUBSTR(CKT,4,1) = 'K') THEN 'ETHERNET'
              WHEN SUBSTR(CKT,4,1) = 'V' THEN 'ETHERNET'
              WHEN SUBSTR(PROJ,1,10) = 'ATTMOB-TLS' THEN 'ETHERNET'
              WHEN SUBSTR(PROJ,1,10) = 'ATTMOB-EVC' THEN 'ETHERNET'
              ELSE RATE_CODE END SERVICE,
         NC, RATE_CODE, WM, B.JEOPARDY_REASON_DESCRIPTION WM_DESC, WMRCA, C.JEOPARDY_REASON_DESCRIPTION WMRCA_DESC, CKT,
        (SELECT UDCV.DISPLAY_VALUE FROM USER_DATA_CATEGORY_VALUES UDCV WHERE A.UNI_OR_NNI = UDCV.USER_DATA_CATEGORY_VALUE_ID) AS UNI_OR_NNI,      
        (SELECT UDCV.DISPLAY_VALUE FROM USER_DATA_CATEGORY_VALUES UDCV WHERE A.BUILD_IOF = UDCV.USER_DATA_CATEGORY_VALUE_ID) AS BUILD_IOF,
        (SELECT UDCV.DISPLAY_VALUE FROM USER_DATA_CATEGORY_VALUES UDCV WHERE A.BUILD_OSP = UDCV.USER_DATA_CATEGORY_VALUE_ID) AS BUILD_OSP       
FROM
(
SELECT SR.PON,
  SR.DOCUMENT_NUMBER,
  ASR.REQUEST_TYPE,
  CASE WHEN NL1.CLLI_CODE IS NOT NULL THEN SUBSTR(NL1.CLLI_CODE,5,2)
       WHEN NL2.CLLI_CODE IS NOT NULL THEN SUBSTR(NL2.CLLI_CODE,5,2)
       ELSE NULL END STATE1,
  MAX(SR.ACTIVITY_IND) KEEP (DENSE_RANK LAST ORDER BY SR.LAST_MODIFIED_DATE) ACT_IND,
  MAX(SR.SUPPLEMENT_TYPE) KEEP (DENSE_RANK LAST ORDER BY SR.LAST_MODIFIED_DATE) SUPP_TYPE,
  MIN(NTS.LAST_MODIFIED_DATE) KEEP (DENSE_RANK FIRST ORDER BY NTS.LAST_MODIFIED_DATE) ASR_INIT,
  MAX(ASR2.DATE_TIME_SENT) KEEP (DENSE_RANK LAST ORDER BY ASR2.LAST_MODIFIED_DATE) CLEANASR, 
  MAX(ASR.DESIRED_DUE_DATE) KEEP (DENSE_RANK LAST ORDER BY ASR.LAST_MODIFIED_DATE) DD, 
  MAX(AUD.CRDD) KEEP (DENSE_RANK LAST ORDER BY AUD.LAST_MODIFIED_DATE) DDD, 
  MIN(AUD.ACCEPTANCE_DATE) KEEP (DENSE_RANK LAST ORDER BY AUD.LAST_MODIFIED_DATE) ACCEPT_DT, 
  MAX(TRUNC(ASAP.PKG_GMT.SF_GMT_AS_PASSED_TIMEZONE(T.ACTUAL_COMPLETION_DATE,1222))) KEEP (DENSE_RANK LAST ORDER BY T.LAST_MODIFIED_DATE) DD_COMP,
  MAX(ASR.ACCESS_PROVIDER_SERV_CTR_CODE) KEEP (DENSE_RANK LAST ORDER BY ASR.LAST_MODIFIED_DATE) ICSC,
  MAX(SR.PROJECT_IDENTIFICATION) KEEP (DENSE_RANK LAST ORDER BY SR.LAST_MODIFIED_DATE) PROJ,
  MAX(SR.ACNA) KEEP (DENSE_RANK LAST ORDER BY SR.LAST_MODIFIED_DATE) ACNA,
  MAX(PRILOC_STATE) KEEP (DENSE_RANK LAST ORDER BY DLR.LAST_MODIFIED_DATE) PRI_STATE,
  MAX(SECLOC_STATE) KEEP (DENSE_RANK LAST ORDER BY DLR.LAST_MODIFIED_DATE) SEC_STATE,
  MAX(CIR.RATE_CODE) KEEP (DENSE_RANK LAST ORDER BY CIR.LAST_MODIFIED_DATE) RATE_CODE,
  MAX(ASR.NETWORK_CHANNEL_SERVICE_CODE) KEEP (DENSE_RANK LAST ORDER BY ASR.LAST_MODIFIED_DATE) NC,
  MAX(ASR.EVC_IND) KEEP (DENSE_RANK LAST ORDER BY ASR.LAST_MODIFIED_DATE) EVC_IND,
  MAX(JW.JEOPARDY_REASON_CODE) KEEP (DENSE_RANK LAST ORDER BY JW.LAST_MODIFIED_DATE) WM,
  MAX(JWRCA.JEOPARDY_REASON_CODE) KEEP (DENSE_RANK LAST ORDER BY JWRCA.LAST_MODIFIED_DATE) WMRCA,
  CIR.EXCHANGE_CARRIER_CIRCUIT_ID CKT,
  JW.JEOPARDY_TYPE_CD JEOP_TYPE,
  JWRCA.JEOPARDY_TYPE_CD RCA_JEOP_TYPE,
  UNI_OR_NNI,
  MAX(BUILD_IOF) KEEP (DENSE_RANK LAST ORDER BY AUD.LAST_MODIFIED_DATE) BUILD_IOF,
  MAX(BUILD_OSP) KEEP (DENSE_RANK LAST ORDER BY AUD.LAST_MODIFIED_DATE) BUILD_OSP,
  SUBSTR(NPA.EXCHANGE_AREA_CLLI,5,2) NPASTATE    
--
FROM SERV_REQ SR, 
     ACCESS_SERVICE_REQUEST ASR,
     ACCESS_SERVICE_REQUEST ASR2,
     ASR_USER_DATA AUD,
     NETWORK_LOCATION NL1,
     NETWORK_LOCATION NL2,
     CIRCUIT CIR,
     DESIGN_LAYOUT_REPORT DLR, 
     TASK T,
     TASK TRCA,
     TASK_JEOPARDY_WHYMISS JW,
     TASK_JEOPARDY_WHYMISS JWRCA,
     NOTES NTS,
     NPA_NXX NPA,
     CIRCUIT_USER_DATA CUD
--
WHERE SR.DOCUMENT_NUMBER = ASR.DOCUMENT_NUMBER(+)
AND SR.DOCUMENT_NUMBER = ASR2.DOCUMENT_NUMBER(+)
AND SR.DOCUMENT_NUMBER = AUD.DOCUMENT_NUMBER (+)
AND SR.FIRST_ECCKT_ID = CIR.EXCHANGE_CARRIER_CIRCUIT_ID (+)
AND CIR.LOCATION_ID = NL1.LOCATION_ID (+)
AND CIR.LOCATION_ID_2 = NL2.LOCATION_ID (+)
AND SR.DOCUMENT_NUMBER = DLR.DOCUMENT_NUMBER (+)
AND SR.DOCUMENT_NUMBER = T.DOCUMENT_NUMBER (+)
AND SR.DOCUMENT_NUMBER = TRCA.DOCUMENT_NUMBER (+)
AND T.TASK_NUMBER = JW.TASK_NUMBER(+)
AND TRCA.TASK_NUMBER = JWRCA.TASK_NUMBER(+)
AND SR.DOCUMENT_NUMBER = NTS.DOCUMENT_NUMBER (+)
AND ASR.NPA = NPA.NPA (+)
AND ASR.NXX = NPA.NXX (+)
AND CIR.CIRCUIT_DESIGN_ID = CUD.CIRCUIT_DESIGN_ID (+)
AND SR.TYPE_OF_SR = 'ASR'
AND T.TASK_TYPE = 'DD'    
AND TRCA.TASK_TYPE(+) = 'RCA'
AND ASR.REQUEST_TYPE IN ('S','E')
AND ASR.ACTIVITY_INDICATOR IN ('N','C')
AND JW.JEOPARDY_TYPE_CD(+) = 'W' 
AND JWRCA.JEOPARDY_TYPE_CD(+) = 'W' 
AND TO_CHAR(T.ACTUAL_COMPLETION_DATE,'YYYYMM') = '202312'   
--
GROUP BY SR.DOCUMENT_NUMBER,
  SR.PON,
  SR.TYPE_OF_SR, 
  ASR.REQUEST_TYPE, 
  CIR.EXCHANGE_CARRIER_CIRCUIT_ID,
  NL1.CLLI_CODE,
  NL2.CLLI_CODE,
  NPA.EXCHANGE_AREA_CLLI,
  JW.JEOPARDY_TYPE_CD,
  JWRCA.JEOPARDY_TYPE_CD,
  UNI_OR_NNI
) A, JEOPARDY_TYPE B, JEOPARDY_TYPE C 
--
WHERE A.WM = B.JEOPARDY_REASON_CODE(+) 
  AND A.JEOP_TYPE = B.JEOPARDY_TYPE_CD(+)
  AND A.WMRCA = C.JEOPARDY_REASON_CODE(+) 
  AND A.RCA_JEOP_TYPE = C.JEOPARDY_TYPE_CD(+) 
 AND (SUPP_TYPE <> '1' OR SUPP_TYPE IS NULL)
-- AND SUBSTR(CKT,7,1) <> 'U'
 AND ACNA IN ('FET','FWN')
)
ORDER BY 4,1
;

